#!/usr/bin/env python3
# Converts the Haiku OS Scrypt password hashes (Inside of /boot/system/settings/etc/shadow) to a format john or hashcat(8900) knows.
__author__ = 'Jon Stratton'

import sys, base64

R = 8
P = 1
HASH_LEN = 32

# Takes a password hash or line from the passwd file, and pull out the needed elements.
def parse_passwd(line):
   n = password_hash = password_salt = None
   for val in line.split(':'):
      if val.startswith('$s$'):
         split_val = val.split('$')
         n = int(split_val[2])
         password_salt = bytes.fromhex(split_val[3])
         password_hash = bytes.fromhex(split_val[4])
   return n, password_hash, password_salt

if __name__ == '__main__':
   in_hash = in_format = None
   for arg in sys.argv:
      if arg.startswith('$s$'):
         in_hash = arg
      if arg == '-j':
         in_format = 'john'

   n, password_hash, password_salt = parse_passwd(in_hash)
   if password_salt:
      if in_format == 'john':
         print("$ScryptKDF.pm$%d*%d*%d*%s*%s" % ((2**n), R, P, base64.b64encode(password_salt).decode(), base64.b64encode(password_hash).decode()))
      else:
         print("SCRYPT:%d:%d:%d:%s:%s" % ((2**n), R, P, base64.b64encode(password_salt).decode(), base64.b64encode(password_hash).decode()))
   else:
      print("No Scrypt hash found.")
